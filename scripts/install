#!/bin/bash
app=odoo
set -e

# Retrieve arguments
domain=$1
odoo_version=$2
admin_password=$3

sudo yunohost app checkport 8069
if [[ ! $? -eq 0 ]]; then
  exit 1
fi

# Check domain/path availability
domain=${domain}"/"
sudo yunohost app checkurl $domain -a $app \
	|| (echo "Path not available: $domain" && exit 1)

# Remove trailing "/" for next commands
domain=${domain%/}
sudo yunohost app setting $app domain -v $domain

# Install Odoo
	# Prepare installation
		sudo apt-get -y install curl
	
	# Install Odoo
		sudo curl -sS https://nightly.odoo.com/odoo.key | sudo apt-key add -
		if [ "$odoo_version" = "8.0" ]; then
			sudo sh -c 'echo "deb http://nightly.odoo.com/8.0/nightly/deb/ ./" > /etc/apt/sources.list.d/odoo.list'
		else
			sudo sh -c 'echo "deb http://nightly.odoo.com/9.0/nightly/deb/ ./" > /etc/apt/sources.list.d/odoo.list'
		fi
		sudo apt-get update
		sudo apt-get -y install wkhtmltopdf
		sudo apt-get -y install odoo
		su - postgres -c "createuser -s odoo" 2> /dev/null || true
	
	# Set admin password
		sudo sed -i "s@ADMIN_PASSWORD@$admin_password@g" ../conf/openerp-server.conf
		sudo cp ../conf/openerp-server.conf /etc/odoo/openerp-server.conf
		sudo chown odoo:odoo /etc/odoo/openerp-server.conf
		
	# Setup LDAP
		sudo sed -i "s@'auto_install': False@'auto_install': True@g" /usr/lib/python2.7/dist-packages/openerp/addons/auth_ldap/__openerp__.py
		
	# Add services
		sudo yunohost service add postgresql
		sudo yunohost service add odoo
		sudo yunohost service stop odoo
		sudo yunohost service start odoo
	
# Configure Nginx and reload
	sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/$app.conf

# Make Odoo public
	sudo yunohost app setting $app skipped_uris -v "/"

sudo service nginx reload
echo $?